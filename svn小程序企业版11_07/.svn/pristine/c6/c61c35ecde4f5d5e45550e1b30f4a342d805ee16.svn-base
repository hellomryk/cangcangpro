// pages/mxjb/mxjb.js
const date = new Date()
const years = []
const months = []
const days = []
const hostlocal1 = "https://chronic-api.infobigdata.com";
const hostlocal = "https://chronic.infobigdata.com";
const sun ='https://chronic-api-part.infobigdata.com';
var app = getApp();
var _this=null;
//主症取选中数组
function ayyr() {
    var psal = [];
    var psal1 = [];
    for (var i = 0; i < _this.data.allGoodsFilte.length; i++) {
        if (_this.data.allGoodsFilte[i].checked) {
            psal.push(_this.data.allGoodsFilte[i].id);
            psal1.push(_this.data.allGoodsFilte[i].label)
        }
    }
    _this.setData({
        ayyr: psal
    })
    _this.setData({
        ayyr1: psal1
    })
    console.log(_this.data.ayyr)

}
//副症取选中数组
function ayyr1() {
    var psal = [];
    var psal1 = [];
    for (var i = 0; i < _this.data.allGoodsFilte1.length; i++) {
        if (_this.data.allGoodsFilte1[i].checked) {
            psal.push(_this.data.allGoodsFilte1[i].id);
            psal1.push(_this.data.allGoodsFilte1[i].label)
        }
    }
    _this.setData({
        ayyr_1: psal
    })
    _this.setData({
        ayyr1_1: psal1
    })
    console.log(_this.data.ayyr_1)

}

Page({

  /**
   * 页面的初始数据
   */
  data: {
      allGoodsFilte: null,
      allGoodsFilte1: null,
      box:false,
      lazy: true,
      nub: 1,
      num: "主要",
      ayyr: [],
      ayyr1: [],
      ayyr_1: [],
      ayyr1_1: [],
      ayyr2: [],
      ayyr3: [],
      ayyr4: {},
 
    years: ["杨坤", "王五", "李兮兮"],
    year: '开始测评', //某一选项的内容
    siginup: "true", //登陆框消息
    canIUse: wx.canIUse('button.open-type.getUserInfo'),
    username: 'yk', //用户名
    windowHeight: '', //
    inputValue: '', //存储输入框中的内容
    openId: '', //
    inputShow: 1, //判断输入框是否存在
    windowHeightChange: 0, //控制聊天框的大小
    scrollTop: '', //滚动的高度
    desisename: '',
    clazzstep: '', //小红记录步骤的参数
    whichnum:0,//默认时候是哪一个
    kaishiceping: '',
    confirmonce:0,//判断是第几次点击确定按钮
    firstprompt:'',//第一次点击确认时候人类的话
    array: [],
      disId:"",//疾病id
      disName: "",//疾病名称
      tijiao:"",
      starttestlist:''
    }, 
  bindChange: function(e) {
    const val = e.detail.value
    console.log(val)
    console.log(e.detail)
    this.setData({
      year: this.data.years[val[0]],
      whichnum: val[0]
    })
  },


  // 获取用户信息start
  bindGetUserInfo: function(e) {
    // console.log(e.detail.userinfo)
  },
  //提交主症副症
    submit:function(){
        if (_this.data.ayyr1.length > 0 && _this.data.ayyr1_1.length > 2){
            //   < !--请求 -->
            wx.request({
                url: sun + '/api/disease/selfTesting/submitSymptom',
                data: {
                    disId: _this.data.disId,
                    disName: _this.data.desisename,
                    mainDisStr: _this.data.ayyr1,
                    viceDisStr: _this.data.ayyr1_1,
                },
                header: {
                    'content-type': 'application/x-www-form-urlencoded' // 默认值application/json
                },
                method: "POST",
                success: function (res) {


                    if (res.data.code == 0) {

                        var obj = {
                            typeId: 1,
                            welcomeuserlist: res.data.data.sdo.name,
                            starttestlist: res.data.data.sdo.probability
                        }
                        var dataarray = _this.data.array;
                        dataarray.push(obj);
                        _this.setData({
                            array: dataarray,
                            tijiao: res.data,
                            starttestlist: res.data.data.sdo.probability
                        })
                        _this.setData({
                                inputShow:2
                                })
                        let query = wx.createSelectorQuery().in(_this);
                        query.select(".container_innerHeight").boundingClientRect((res) => {
                            console.log('下滑高度')
                            console.log(res)
                            _this.setData({
                                scrollTop: res.height + 100
                            })
                        }).exec()
                    } else {
                        wx.showToast({
                            title: "您选的症状还不足以诊断出所患疾病",
                            icon: 'none',
                            duration: 2000
                        })
                    }

                }
            })
        }else{
            wx.showToast({
                title: "为了能准确判定疾病请选择主要症状(最少1个)和副症状(最少3个)",
                icon: 'none',
                duration: 1500
            })
        }

    },
  /**
   * 生命周期函数--监听页面加载
   */
  onLoad: function(options) {
    // const _this = this;
      _this = this;
      _this.setData({
          desisename: options.desisename
      })
  
        //   < !--请求 -->
              wx.request({
                  url: sun +'/api/disease/selfTesting/getSymptom',
                  data: {
                      disName: _this.data.desisename
                  },
                  header: {
                      'content-type': 'application/x-www-form-urlencoded' // 默认值application/json
                  },
                  method: "POST",
                  success: function (res) {
                      console.log(res)
                      console.log(1111111111)
                      console.log(res.data.data.mainDisList)
                      _this.setData({
                          allGoodsFilte: res.data.data.mainDisList,
                          allGoodsFilte1: res.data.data.viceDisList,
                          disId: res.data.data.disId
                      })
                      console.log(_this.data.allGoodsFilte)
                  }
              })




















    //计算屏幕高度
    wx.getSystemInfo({
      success: function(res) {
        let clientHeight = res.windowHeight,
          clientWidth = res.windowWidth,
          rpxR = 750 / clientWidth;
        var calc = clientHeight * rpxR;
        console.log(calc)
        _this.setData({
          windowHeight: calc
        })
      }
    })
    //获取登陆用户名
    wx.getSetting({
      success: function(res) {
        if (res.authSetting['scope.userInfo']) {
          // 已经授权，可以直接调用 getUserInfo 获取头像昵称
          wx.getUserInfo({
            success: function(res) {
              _this.setData({
                username: res.userInfo.nickName
              })
              wx.request({
                url: hostlocal+'/doctorapplet/f52024d75d4348f38cdad3670d209c1e/doctorinit',
                header: {
                  'content-type': "application/json"
                },
                method: 'GET',
                data: {
                  username: encodeURI(_this.data.username),
                  dieasename: encodeURI(_this.data.desisename)
                },
                success: function(res) {
                  console.log("onload加载时数据")
                  console.log(res)
                  console.log(res.data.firstprompt)
                  var arronload = res.data.firstprompt.split(',');
                  console.log(arronload)
                  _this.setData({
                    years: arronload,
                    firstprompt:res.data.firstprompt,
                  })

                  if (res.data.showType == -1) {
                    var obj1 = {
                      typeId: -1,
                      welcomeuser: res.data.secondprompt.welcomeuser,
                      starttest: res.data.secondprompt.functionli.buttonone,
                      lookhistory: res.data.secondprompt.functionli.buttontwo,
                      firstprompt: res.data.firstprompt
                    }
                    var dataarray = _this.data.array;
                    dataarray.push(obj1)
                    _this.setData({
                      array: dataarray
                    })
                  }
                  //滚动到底部
                  let query = wx.createSelectorQuery().in(_this);
                  query.select(".container_innerHeight").boundingClientRect((res) => {
                    _this.setData({
                      scrollTop: res.height
                    })
                  }).exec()
                }
              })
            }
          })
        }
      }
    })
    // https://chronic.infobigdata.com/doctorapplet/f52024d75d4348f38cdad3670d209c1e/doctorinit


  },
  //存储input输入内容
  catchMessage: function(e) {
    const _this = this;
    if (e.detail.value != "") {
      _this.setData({
        inputValue: e.detail.value
      })
    }
  },
  //确认键盘输入
  submitMessage: function() {
    const _this = this;
    sendmessage_pub(_this)
  },
  //点击发送按钮
  sendmsg: function(e) {
    const _this = this;
    console.log("fasong")
    sendmessage_pub(_this)
    sendmessage_pubId(_this)
    console.log(_this.data.array)
  },
  //控制登录按钮开关
  siginuptab: function() {
    const _this = this;
    _this.setData({
      siginup: false
    })
  },
    serviceValChange: function (e) {
        var allGoodsFilte = this.data.allGoodsFilte;
        var checkArr = e.detail.value;
        console.log(checkArr)
        for (var i = 0; i < allGoodsFilte.length; i++) {
            if (checkArr.indexOf(i + "") != -1) {
                allGoodsFilte[i].checked = true;
            } else {
                allGoodsFilte[i].checked = false;
            }
        }
        this.setData({
            allGoodsFilte: allGoodsFilte,
        })
        ayyr();

    },
    serviceValChange1: function (e) {
        var allGoodsFilte = this.data.allGoodsFilte1;
        var checkArr = e.detail.value;
        console.log(checkArr)
        for (var i = 0; i < allGoodsFilte.length; i++) {
            if (checkArr.indexOf(i + "") != -1) {
                allGoodsFilte[i].checked = true;
            } else {
                allGoodsFilte[i].checked = false;
            }
        }
        this.setData({
            allGoodsFilte1: allGoodsFilte,
        })
        ayyr1();

    },

  starttest() {
      _this.data.array.push({ typeId: 0})
              _this.setData({
                  array: _this.data.array
              })

            //   _this.setData({
            //     inputShow:0
            //   })
            // var obj2 = {
            //   typeId: 1,
            //   robotsay: "请选择以下伴随或出现过的主症状？",
            // }
            // var dataarray = _this.data.array;
            // dataarray.push(obj2)
            // _this.setData({
            //   windowHeightChange: 350,
            //   array: dataarray
            // })
             //滚动到底部
              let query = wx.createSelectorQuery().in(_this);
              query.select(".container_innerHeight").boundingClientRect((res) => {
                console.log('下滑高度')
                console.log(res)
                _this.setData({
                  scrollTop: res.height + 100
                })
              }).exec()
            
  },
  //选择确认按钮
  confirmbtn() {
    const _this = this;
    _this.data.confirmonce++;
    console.log(_this.data.confirmonce)
    _this.setData({
      openId: app.globalData.openId
    })

    if (_this.data.confirmonce == 0) {
    } else if (_this.data.confirmonce == 1) {

      _this.setData({

        windowHeightChange: 350,
      })
      //发送输入信息开始
      wx.request({
        url: hostlocal + '/doctorapplet/f52024d75d4348f38cdad3670d209c1e/selftest',
        data: {
          openid: app.globalData.openId,
          issue: encodeURI(_this.data.desisename)
          //  issue: encodeURI("都不是")
        },
        method: 'GET',
        success: function (data) {


          _this.setData({
            kaishiceping: true
          })
          if (data.data.inputShow == 0) {
            var arr = data.data.prompt.split('[')
            var arr2 = arr[1].split("]")
            var obj1 = {
              typeId: 1,
              robotsay: data.data.data
            }
            var obj2 = {
              typeId: 0,
              message: _this.data.year
            }
            var dataarray = _this.data.array;
            dataarray.push(obj2)
            dataarray.push(obj1)
            _this.setData({
              years: arr2[0].split(','),
              year: arr2[0].split(',')[0],
              inputShow: data.data.inputShow,
              windowHeightChange: 350,
              array: dataarray
            })
            console.log(arr2[0].split(','))
          } else if (data.data.inputShow == 1) {
            var obj2 = {
              typeId: 0,
              message: _this.data.year
            }
            var obj3 = {
              typeId: 2,
              welcomeuserlist: data.data.data,
              starttestlist: data.data.prompt
            }
            var dataarray = _this.data.array;
            dataarray.push(obj2)
            dataarray.push(obj3)
            _this.setData({
              windowHeightChange: 0,
              inputShow: data.data.inputShow,
              array: dataarray
            })
            // console.log(JSON.parse(data.data.prompt))
          } else {
            console.log("保存1")
            console.log(data.data.showType)
            if (data.data.showType == 3) {
              console.log("保存")
              console.log(JSON.parse(data.data).diseaseName)
              var obj3 = {
                typeId: 3,
                welcomeuserlist: JSON.parse(data.data).diseaseName,
                starttestlist: JSON.parse(data.data).diseaseProbability
              }
              var dataarray = _this.data.array;
              dataarray.push(obj3)
              _this.setData({
                windowHeightChange: 200,
                inputShow: data.data.inputShow,
                array: dataarray
              })
            }
            if (data.data.showType == 4) {
              var obj3 = {
                typeId: 4,
                welcomeuserlist: JSON.parse(data.data).diseaseName,
                starttestlist: JSON.parse(data.data).diseaseProbability
              }
              var dataarray = _this.data.array;
              dataarray.push(obj3)
              _this.setData({
                windowHeightChange: 200,
                inputShow: data.data.inputShow,
                array: dataarray
              })
            }
          }
          //滚动到底部
          let query = wx.createSelectorQuery().in(_this);
          query.select(".container_innerHeight").boundingClientRect((res) => {
            console.log('下滑高度')
            console.log(res)
            _this.setData({
              scrollTop: res.height
            })
          }).exec()
        }
      })
              // 发送输入信息结束
    }else {
      if (_this.data.year == "不清楚" || _this.data.year == "继续自测") {
      } else {
        var newYears = _this.data.years;
        var temStr = "";
        for (var z = 1; z < newYears.length; z++) {
          if (z != newYears.length) {
            if (temStr == "") {
              temStr = newYears[z - 1];
            } else {
              temStr += "、" + newYears[z - 1];
            }
          }
        }
        if (temStr != "") {
          _this.data.year = temStr;
        }
      }
      //发送输入信息开始
      wx.request({
        url: hostlocal + '/doctorapplet/f52024d75d4348f38cdad3670d209c1e/selftest',
        data: {
          openid: app.globalData.openId,
          issue: encodeURI(_this.data.year),
          clazzstep: encodeURI(_this.data.clazzstep)
        },
        method: 'GET',
        success: function (data) {
          console.log("确认按钮")
          console.log(data.data.clazzstep)
          console.log(data)
          console.log(data.data.prompt)
          _this.setData({
            clazzstep: data.data.clazzstep
          })
          if (data.data.inputShow == 0) {
            var arr = data.data.prompt.split('[')
            var arr2 = arr[1].split("]")
            var obj1 = {
              typeId: 1,
              robotsay: data.data.data
            }
            var obj2 = {
              typeId: 0,
              message: _this.data.year
            }
            var dataarray = _this.data.array;
            dataarray.push(obj2)
            dataarray.push(obj1)
            var numindex = _this.data.whichnum;
            console.log("ykkkkkkkkkkkkkkkkkk")
            console.log(numindex)
            _this.setData({
              years: arr2[0].split(','),
              year: arr2[0].split(',')[numindex],
              inputShow: data.data.inputShow,
              windowHeightChange: 400,
              array: dataarray
            })
            console.log(arr2[0].split(','))
          } else if (data.data.inputShow == 1) {
            console.log(data.data.prompt)
            var obj2 = {
              typeId: 0,
              message: _this.data.year
            }
            var obj3 = {
              typeId: 2,
              welcomeuserlist: data.data.data,
              starttestlist: data.data.prompt
            }
            var dataarray = _this.data.array;
            dataarray.push(obj2)
            dataarray.push(obj3)
            _this.setData({
              windowHeightChange: 0,
              inputShow: data.data.inputShow,
              array: dataarray
            })
            // console.log(JSON.parse(data.data.prompt))
          } else if (data.data.inputShow == 2) {
            console.log("保存1")
            console.log(data.data.showType)
            if (data.data.showType == 3) {
              console.log("保存")
              console.log(JSON.parse(data.data.data).diseaseName)
              var obj2 = {
                typeId: 0,
                message: _this.data.year
              }
              var obj4 = {
                typeId: 3,
                welcomeuserlist: JSON.parse(data.data.data).diseaseName,
                starttestlist: JSON.parse(data.data.data).diseaseProbability
              }
              var dataarray = _this.data.array;
              dataarray.push(obj2)
              dataarray.push(obj4)
              _this.setData({
                windowHeightChange: 50,
                inputShow: data.data.inputShow,
                array: dataarray
              })
            }

          } else {
            if (data.data.showType == 4) {
              var obj2 = {
                typeId: 0,
                message: data.data.data
              }
              var obj1 = {
                typeId: 4,
                welcomeuser: "此时无结果,欢迎继续测评",
                starttest: "开始测评",
                lookhistory: "测评历史",
                // firstprompt: ""
              }
              var dataarray = _this.data.array;
              dataarray.push(obj2)
              dataarray.push(obj1)
              _this.setData({
                windowHeightChange: 0,
                inputShow: data.data.inputShow,
                array: dataarray
              })
            }
          }
          //滚动到底部
          let query = wx.createSelectorQuery().in(_this);
          query.select(".container_innerHeight").boundingClientRect((res) => {
            console.log('下滑高度')
            console.log(res)
            _this.setData({
              scrollTop: res.height
            })
          }).exec()

        }
      })
              // 发送输入信息结束
    }
    
  },

    nobaocun:function() {
        wx.switchTab({
        url: '/pages/desiselist/desiselist'
    })
  },
  baocun:function()  {

    // wx.navigateTo({
    //   url: '/pages/shouye/shouye'
    // })


      _this.setData({
          openId: app.globalData.openId
      })


      //保存信息
      //获取登陆用户名
      wx.getSetting({
          success: function (res) {
              if (res.authSetting['scope.userInfo']) {
                  // 已经授权，可以直接调用 getUserInfo 获取头像昵称
                  wx.getUserInfo({
                      success: function (res) {
                          _this.setData({
                              starttestlist: _this.data.starttestlist.substring(0, _this.data.starttestlist.length-1)
                          })
                          
                          wx.request({
                              url: sun + '/api/disease/selfTesting/saveReport',
                              data: {
                                  basicInfo: res.userInfo.nickName,
                                  openId: app.globalData.openId,
                                  recordType: 2,
                                  symptoms: '{' + '"diseaseName":"' + _this.data.tijiao.data.sdo.name + '",' + '"symptoms":"' + _this.data.tijiao.data.mainDisStr + ','+ _this.data.tijiao.data.viceDisStr + '",' + '"probability":"' + _this.data.starttestlist + '",' + '"id":"' + _this.data.tijiao.data.sdo.id +'"}',

                              },
                              header: {
                                  'content-type': 'application/x-www-form-urlencoded' // 默认值application/json
                              },
                              method: "POST",
                              success: function (res) {
                                  if (res.data.code){
                                      wx.showToast({
                                          title: res.data.msg,
                                          icon: 'none',
                                          duration: 600
                                      })
                                    wx.switchTab({
                                        url: '/pages/shouye/shouye',
                                    })
                                  }else{
                                      wx.showToast({
                                          title: res.data.msg,
                                          icon: 'none',
                                          duration: 2000
                                      })
                                  }

                              }
                              //滚动到底部
                          })

                      }
                  })
              }
          }
      })

  },
  //   siginuptab: function() {
  //     const _this = this;
  //     _this.setData({
  //       siginup: false
  //     })
  //   }
  /**
   * 生命周期函数--监听页面初次渲染完成
   */
  onReady: function() {

  },

  /**
   * 生命周期函数--监听页面显示
   */
  onShow: function() {
    const _this = this;
    wx.getSetting({
      success(res) {
        if (!res.authSetting['scope.userInfo']) {
          _this.setData({
            siginup: true,
          })
        } else {
          _this.setData({
            siginup: false
          })
        }
      }
    })

  },

  /**
   * 生命周期函数--监听页面隐藏
   */
  onHide: function() {

  },

  /**
   * 生命周期函数--监听页面卸载
   */
  onUnload: function() {

  },

  /**
   * 页面相关事件处理函数--监听用户下拉动作
   */
  onPullDownRefresh: function() {

  },

  /**
   * 页面上拉触底事件的处理函数
   */
  onReachBottom: function() {

  },

  /**
   * 用户点击右上角分享
   */
  onShareAppMessage: function() {

  }
})

// 发送事件封装
function sendmessage_pub(_this) {
  var inputContent = _this.data.inputValue;
  if (inputContent != "") {
    //   var obj = {
    //     typeId:0,
    //     message:inputContent
    //   }
    //  var dataarray = _this.data.array
    //   dataarray.push(obj)
    // _this.setData({
    //   array:dataarray,
    //   inputValue:''
    // })
  }
}
//发送事件(带openid)封装
function sendmessage_pubId(_this) {
  // 获取小程序id开始
  var user = wx.getStorageSync('user') || {};
  var userInfo = wx.getStorageSync('userInfo') || {};
  console.log(123)
  wx.login({
    success: function(res) {
      console.log(res)
      if (res.code) {
        wx.getUserInfo({
          success: function(res) {
            var objz = {};
            objz.avatarUrl = res.userInfo.avatarUrl;
            objz.nickName = res.userInfo.nickName;
            // wx.setStorageSync('userInfo', objz); //存储userInfo
          }
        });
        const appkey = 'wx84cae8ce6e9453d4'
        const appsecret = '39e817b148c512cde7ead6c4b3cde98a'
        // var l = 'https://jqr.infobigdata.com/weixin/getWeixinInfo'
          var l = hostlocal1+'/weixin/getWeixinInfo'
        // console.log(res)
        wx.request({
          url: l,
          data: {
            code: res.code
          },
          method: 'GET', // OPTIONS, GET, HEAD, POST, PUT, DELETE, TRACE, CONNECT  
          // header: {}, // 设置请求的 header  
          success: function(res) {
            var obj = {};
            console.log(res)
            obj.openid = res.data.openid;
            obj.expires_in = Date.now() + res.data.expires_in;
            console.log("打印openid开始")
            console.log(obj.openid);
            _this.setData({
              openId: app.globalData.openId
            })
            console.log("打印openid结束")
            wx.setStorageSync('user', obj); //存储openid 
            //发送输入信息开始
            wx.request({
              url: 'https://chronic.infobigdata.com/doctorapplet/f52024d75d4348f38cdad3670d209c1e/doctorqs',
              data: {
                openid: app.globalData.openId,
                issue: encodeURI(_this.data.inputValue)
                //issue: encodeURI("通过症状列表选择")
              },
              method: 'GET',
              success: function(data) {
                if (data.data.inputShow == 0) {
                  var arr = data.data.prompt.split('[')
                  var arr2 = arr[1].split("]")
                  var obj1 = {
                    typeId: 1,
                    robotsay: data.data.data
                  }
                  var obj2 = {
                    typeId: 0,
                    message: _this.data.year
                  }
                  var dataarray = _this.data.array;
                  dataarray.push(obj2)
                  dataarray.push(obj1)
                  var num1 = _this.data.whichnum
                  console.log("ykkkkkkkkkkkk")
                  console.log(num1)
                  console.log(arr2[0].split(',')[num1])
                  _this.setData({
                    years: arr2[0].split(','),
                    year: arr2[0].split(',')[num1],
                    inputShow: data.data.inputShow,
                    windowHeightChange: 400,
                    array: dataarray
                  })
                  console.log(arr2[0].split(','))
                } else {
                  console.log(data.data.prompt)
                  var obj2 = {
                    typeId: 0,
                    message: _this.data.year
                  }
                  var obj3 = {
                    typeId: 2,
                    welcomeuserlist: data.data.data,
                    starttestlist: data.data.prompt
                  }
                  var dataarray = _this.data.array;
                  dataarray.push(obj2)
                  dataarray.push(obj3)
                  _this.setData({
                    windowHeightChange: 0,
                    inputShow: data.data.inputShow,
                    array: dataarray
                  })
                  // console.log(JSON.parse(data.data.prompt))
                }
                //滚动到底部
                let query = wx.createSelectorQuery().in(_this);
                query.select(".container_innerHeight").boundingClientRect((res) => {
                  console.log('下滑高度')
                  console.log(res)
                  _this.setData({
                    scrollTop: res.height
                  })
                }).exec()
              }
            })
            // 发送输入信息结束
          }
        });
      } else {
        console.log('获取用户登录态失败！' + res.errMsg)
      }
    }
  });
  //获取小程序id结束
}